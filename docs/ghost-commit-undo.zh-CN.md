# Ghost Commit 和撤销功能

本文档介绍 Codex 的快照和撤销功能，这是一种类似于"检查点"的机制，允许您恢复文件到之前的状态。

## 概述

当启用 `ghost_commit` 功能时，Codex 会在每次对话轮次之前创建工作目录的快照。这些"幽灵提交"（ghost commits）是特殊的 Git 提交，具有以下特点：

- **完整捕获仓库状态**：包括已跟踪文件、未跟踪文件，以及可选的被忽略文件
- **不影响实际 Git 历史**：HEAD 指针不会移动，您的真实提交历史保持不变
- **支持 `/undo` 命令**：可以将文件恢复到上一轮对话之前的状态

## 启用 Ghost Commit

在您的配置文件 `~/.codex/config.toml` 中添加以下内容：

```toml
[features]
ghost_commit = true
```

## 使用 /undo 命令

### 功能说明

`/undo` 命令将您的工作目录恢复到最近一次对话轮次之前的状态。当 Codex 做出了您不想要的更改时，这个命令非常有用。

### 前置条件

- 必须在配置中启用 `ghost_commit` 功能
- 必须有可用的快照（即至少已完成一次对话轮次）

### 工作原理

1. 当 `ghost_commit` 启用后，Codex 在每次对话轮次开始前会创建一个快照
2. 这个快照记录了当时工作目录的完整状态
3. 使用 `/undo` 命令时，Codex 会将所有文件恢复到最近快照的状态
4. 这实际上撤销了上一轮对话中所做的所有文件更改

### 使用示例

```
> 请帮我重构 main.py 文件

[Codex 进行了修改...]

> /undo

✓ 已恢复快照 abc1234f。
```

## 当前限制

> **注意**：目前 `/undo` 只能恢复到最近的一个快照。它不支持：
> - 从多个历史快照中选择
> - 跳转到对话历史中的任意时间点
> - 连续多次撤销（每次只能撤销最后一轮）

如果没有可用的快照（例如 `ghost_commit` 未启用，或者您处于会话开始时），`/undo` 会提示没有可用的快照。

## 常见问题

### Q: ghost_commit 和普通的 git commit 有什么区别？

A: Ghost commit 是 Codex 内部使用的特殊提交，它：
- 不会出现在您的 `git log` 中
- 不会移动 HEAD 指针
- 仅用于支持撤销功能
- 会自动管理，无需手动操作

### Q: 启用 ghost_commit 会影响性能吗？

A: 可能会略微增加每轮对话的启动时间，因为需要创建快照。但对于大多数项目来说，这个影响是可以忽略的。

### Q: 如何查看当前是否有可用的快照？

A: 直接使用 `/undo` 命令，如果没有可用的快照，Codex 会告诉您。

### Q: 我可以恢复到更早的快照吗？

A: 目前不支持。`/undo` 只能恢复到最近的一个快照。未来版本可能会支持选择历史快照。

## 相关文档

- [配置文档](./config.md) - 了解更多配置选项
- [斜杠命令](./slash_commands.md) - 所有可用的斜杠命令
