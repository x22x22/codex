# Codex Agent 可用工具分析报告

本报告详细分析了 Codex Agent 在运行时可以使用的各种工具。这些工具使得 Agent 能够执行代码编辑、命令运行、文件操作等任务。

---

## 目录

1. [工具概述](#工具概述)
2. [核心工具](#核心工具)
   - [Shell 命令执行工具](#shell-命令执行工具)
   - [文件编辑工具](#文件编辑工具)
   - [计划管理工具](#计划管理工具)
   - [文件读取工具](#文件读取工具)
   - [目录列表工具](#目录列表工具)
   - [文件搜索工具](#文件搜索工具)
   - [图像查看工具](#图像查看工具)
3. [MCP 工具](#mcp-工具)
   - [MCP 资源列表工具](#mcp-资源列表工具)
   - [MCP 资源模板列表工具](#mcp-资源模板列表工具)
   - [MCP 资源读取工具](#mcp-资源读取工具)
   - [自定义 MCP 工具](#自定义-mcp-工具)
4. [网页搜索工具](#网页搜索工具)
5. [工具配置与启用条件](#工具配置与启用条件)
6. [总结](#总结)

---

## 工具概述

Codex Agent 的工具系统采用模块化设计，包含两种主要类型：

1. **函数工具 (Function Tools)**: 内置的核心工具，用于执行常见操作
2. **MCP 工具 (Model Context Protocol Tools)**: 通过 MCP 服务器扩展的外部工具

工具的配置和启用取决于多个因素：
- 所使用的模型类型
- 功能特性标志 (Feature Flags)
- 用户配置

---

## 核心工具

### Shell 命令执行工具

Agent 有多种执行 Shell 命令的方式：

#### 1. `shell` 工具

**描述**: 运行 Shell 命令并返回输出

**参数**:
| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| `command` | 字符串数组 | 是 | 要执行的命令及参数 |
| `workdir` | 字符串 | 否 | 命令执行的工作目录 |
| `timeout_ms` | 数字 | 否 | 命令超时时间（毫秒） |
| `sandbox_permissions` | 字符串 | 否 | 沙箱权限设置 |
| `justification` | 字符串 | 否 | 请求提升权限时的说明 |

**使用示例**:
- Linux/macOS: `["bash", "-lc", "ls -la"]`
- Windows: `["powershell.exe", "-Command", "Get-ChildItem -Force"]`

---

#### 2. `shell_command` 工具

**描述**: 在用户默认 Shell 中执行脚本命令

**参数**:
| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| `command` | 字符串 | 是 | 要执行的 Shell 脚本 |
| `workdir` | 字符串 | 否 | 命令执行的工作目录 |
| `login` | 布尔值 | 否 | 是否使用登录 Shell 语义（默认 true） |
| `timeout_ms` | 数字 | 否 | 命令超时时间（毫秒） |
| `sandbox_permissions` | 字符串 | 否 | 沙箱权限设置 |
| `justification` | 字符串 | 否 | 请求提升权限时的说明 |

---

#### 3. `exec_command` 工具（统一执行）

**描述**: 在 PTY 中运行命令，返回输出或会话 ID 用于持续交互

**参数**:
| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| `cmd` | 字符串 | 是 | 要执行的 Shell 命令 |
| `workdir` | 字符串 | 否 | 工作目录 |
| `shell` | 字符串 | 否 | Shell 二进制文件路径（默认 /bin/bash） |
| `login` | 布尔值 | 否 | 是否使用 -l/-i 语义（默认 true） |
| `yield_time_ms` | 数字 | 否 | 等待输出的时间（毫秒） |
| `max_output_tokens` | 数字 | 否 | 返回的最大 token 数量 |
| `sandbox_permissions` | 字符串 | 否 | 沙箱权限设置 |
| `justification` | 字符串 | 否 | 请求提升权限时的说明 |

---

#### 4. `write_stdin` 工具

**描述**: 向现有的统一执行会话写入字符并返回最近的输出

**参数**:
| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| `session_id` | 数字 | 是 | 运行中的统一执行会话标识符 |
| `chars` | 字符串 | 否 | 要写入 stdin 的字符（可为空以轮询） |
| `yield_time_ms` | 数字 | 否 | 等待输出的时间（毫秒） |
| `max_output_tokens` | 数字 | 否 | 返回的最大 token 数量 |

---

### 文件编辑工具

#### `apply_patch` 工具

**描述**: 使用补丁格式编辑文件。这是一个自由格式工具，不需要将补丁包装在 JSON 中。

**格式**: 使用简化的文件导向 diff 格式

**补丁语法结构**:
```
*** Begin Patch
[ 一个或多个文件操作 ]
*** End Patch
```

**支持的操作**:

1. **添加文件**: `*** Add File: <路径>`
2. **删除文件**: `*** Delete File: <路径>`
3. **更新文件**: `*** Update File: <路径>`
   - 可选移动: `*** Move to: <新路径>`
   - 修改块: `@@ [可选的上下文标识符]`

**行前缀**:
- ` ` (空格): 上下文行
- `-`: 删除行
- `+`: 添加行

**完整示例**:
```
*** Begin Patch
*** Add File: hello.txt
+Hello world
*** Update File: src/app.py
*** Move to: src/main.py
@@ def greet():
-print("Hi")
+print("Hello, world!")
*** Delete File: obsolete.txt
*** End Patch
```

---

### 计划管理工具

#### `update_plan` 工具

**描述**: 更新任务计划。提供可选说明和计划项列表，每个项目包含步骤和状态。

**参数**:
| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| `explanation` | 字符串 | 否 | 对计划变更的说明 |
| `plan` | 数组 | 是 | 步骤列表 |

**计划项结构**:
| 字段 | 类型 | 描述 |
|------|------|------|
| `step` | 字符串 | 步骤描述 |
| `status` | 字符串 | 状态：`pending`、`in_progress` 或 `completed` |

**使用规则**:
- 同一时间最多只有一个步骤处于 `in_progress` 状态
- 用于跟踪复杂、多阶段任务的进度
- 不应用于简单的单步查询

---

### 文件读取工具

#### `read_file` 工具（实验性）

**描述**: 读取本地文件，支持 1 索引的行号，支持切片和缩进感知块模式

**参数**:
| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| `file_path` | 字符串 | 是 | 文件的绝对路径 |
| `offset` | 数字 | 否 | 开始读取的行号（必须 ≥ 1） |
| `limit` | 数字 | 否 | 返回的最大行数 |
| `mode` | 字符串 | 否 | 模式：`slice`（默认）或 `indentation` |
| `indentation` | 对象 | 否 | 缩进模式的配置 |

**缩进配置参数**:
| 参数名 | 类型 | 描述 |
|--------|------|------|
| `anchor_line` | 数字 | 锚点行（默认为 offset） |
| `max_levels` | 数字 | 要包含的父缩进级别数 |
| `include_siblings` | 布尔值 | 是否包含同级块 |
| `include_header` | 布尔值 | 是否包含文档注释或属性 |
| `max_lines` | 数字 | 返回行数的硬限制 |

---

### 目录列表工具

#### `list_dir` 工具（实验性）

**描述**: 列出本地目录中的条目，带有 1 索引的条目号和简单类型标签

**参数**:
| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| `dir_path` | 字符串 | 是 | 目录的绝对路径 |
| `offset` | 数字 | 否 | 开始列出的条目号（必须 ≥ 1，默认 1） |
| `limit` | 数字 | 否 | 返回的最大条目数（默认 25） |
| `depth` | 数字 | 否 | 最大遍历深度（必须 ≥ 1，默认 2） |

**输出格式**:
- 目录以 `/` 结尾
- 符号链接以 `@` 结尾
- 其他类型以 `?` 结尾
- 常规文件无后缀

---

### 文件搜索工具

#### `grep_files` 工具（实验性）

**描述**: 查找内容匹配模式的文件，并按修改时间列出

**参数**:
| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| `pattern` | 字符串 | 是 | 要搜索的正则表达式模式 |
| `include` | 字符串 | 否 | 限制搜索文件的 glob 模式（如 `*.rs`） |
| `path` | 字符串 | 否 | 搜索的目录或文件路径 |
| `limit` | 数字 | 否 | 返回的最大文件路径数（默认 100） |

**实现说明**: 内部使用 `ripgrep (rg)` 进行搜索

---

### 图像查看工具

#### `view_image` 工具

**描述**: 将本地图像（通过文件系统路径）附加到本轮的线程上下文中

**参数**:
| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| `path` | 字符串 | 是 | 图像文件的本地文件系统路径 |

---

## MCP 工具

MCP（Model Context Protocol）是一种协议，允许 Codex 连接到外部 MCP 服务器以扩展其功能。

### MCP 资源列表工具

#### `list_mcp_resources` 工具

**描述**: 列出 MCP 服务器提供的资源。资源允许服务器共享为语言模型提供上下文的数据，如文件、数据库架构或应用程序特定信息。

**参数**:
| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| `server` | 字符串 | 否 | MCP 服务器名称。省略时列出所有配置服务器的资源 |
| `cursor` | 字符串 | 否 | 上一次调用返回的不透明游标，用于分页 |

---

### MCP 资源模板列表工具

#### `list_mcp_resource_templates` 工具

**描述**: 列出 MCP 服务器提供的资源模板。参数化资源模板允许服务器共享接受参数的数据。

**参数**:
| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| `server` | 字符串 | 否 | MCP 服务器名称。省略时列出所有配置服务器的资源模板 |
| `cursor` | 字符串 | 否 | 上一次调用返回的不透明游标，用于分页 |

---

### MCP 资源读取工具

#### `read_mcp_resource` 工具

**描述**: 根据服务器名称和资源 URI 从 MCP 服务器读取特定资源

**参数**:
| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| `server` | 字符串 | 是 | MCP 服务器名称，必须与配置中的完全匹配 |
| `uri` | 字符串 | 是 | 要读取的资源 URI |

---

### 自定义 MCP 工具

MCP 服务器可以提供自定义工具，这些工具在 Codex 启动时动态注册。工具名称使用完全限定格式：`<服务器名称>__<工具名称>`

**配置位置**: `~/.codex/config.toml`

**配置示例**:
```toml
[mcp_servers.my_server]
command = "my-mcp-server"
args = ["--port", "3000"]
```

---

## 网页搜索工具

#### `web_search` 工具

**描述**: 执行网页搜索以获取最新信息

**类型**: 内置工具（非函数工具）

**启用条件**:
- 需要启用 `WebSearchRequest` 或 `WebSearchCached` 功能特性
- `WebSearchCached` 模式下 `external_web_access` 设为 `false`
- `WebSearchRequest` 模式下 `external_web_access` 设为 `true`

---

## 工具配置与启用条件

### 工具启用矩阵

| 工具名称 | 启用条件 |
|----------|----------|
| `shell` | `ShellTool` 功能启用且 `shell_type = Default` |
| `shell_command` | `ShellTool` 功能启用且 `shell_type = ShellCommand` |
| `exec_command` / `write_stdin` | `UnifiedExec` 功能启用 |
| `apply_patch` | `ApplyPatchFreeform` 功能启用或模型支持 |
| `update_plan` | 始终启用 |
| `view_image` | 始终启用 |
| `list_mcp_resources` | 始终启用 |
| `list_mcp_resource_templates` | 始终启用 |
| `read_mcp_resource` | 始终启用 |
| `grep_files` | 在模型的 `experimental_supported_tools` 中 |
| `read_file` | 在模型的 `experimental_supported_tools` 中 |
| `list_dir` | 在模型的 `experimental_supported_tools` 中 |
| `web_search` | `WebSearchRequest` 或 `WebSearchCached` 功能启用 |
| MCP 自定义工具 | 配置了相应的 MCP 服务器 |

### Shell 工具类型

根据配置和模型，Shell 工具有不同的变体：

| 类型 | 描述 |
|------|------|
| `Default` | 使用 `shell` 工具（命令作为数组） |
| `Local` | 使用 `local_shell` 工具 |
| `UnifiedExec` | 使用 `exec_command` 和 `write_stdin` 工具 |
| `ShellCommand` | 使用 `shell_command` 工具（命令作为字符串） |
| `Disabled` | 不启用 Shell 工具 |

---

## 总结

Codex Agent 提供了一套丰富的工具集，使其能够：

1. **执行命令**: 通过多种 Shell 工具变体运行系统命令
2. **编辑文件**: 使用 `apply_patch` 工具进行精确的文件修改
3. **读取文件**: 支持切片和缩进感知的文件读取（实验性）
4. **浏览目录**: 递归列出目录内容（实验性）
5. **搜索文件**: 使用正则表达式搜索文件内容（实验性）
6. **管理计划**: 跟踪和更新任务进度
7. **查看图像**: 将图像附加到对话上下文
8. **访问 MCP 资源**: 连接外部 MCP 服务器获取额外功能
9. **网页搜索**: 获取最新的网络信息（需启用）

这些工具的组合使得 Codex Agent 成为一个功能强大的编码助手，能够处理从简单的文件编辑到复杂的多步骤开发任务。

---

*报告生成时间: 2024*
*数据来源: codex-rs/core/src/tools/ 目录下的源代码分析*
